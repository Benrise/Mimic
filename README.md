# Инструкция по подключению к серверу через VS Code

Для подключения к серверу через VS Code необходим плагин **Remote - SSH**.

## Шаги настройки

1. **Подготовьте приватный ключ**  
   - Найдите приватный ключ (файл *user@host.key*, который есть в репозитории).  
   - Измените права доступа для этого ключа, чтобы он был доступен только владельцу (требование SSH для безопасности):
     ```bash
     chmod 400 /path/to/your/key/user@host.key
     ```

     ```bash
      icacls "C:\Users\<Имя пользователя>\.ssh\prodml-bootcamp-app-sa@84.201.168.6.key" /inheritance:r /grant:r "<whoami>:R"
     ```
   
2. **Установите плагин Remote - SSH**  
   - Откройте VS Code.  
   - Перейдите в раздел **Extensions** (иконка квадратов слева или сочетание клавиш *Ctrl+Shift+X*).  
   - Найдите **Remote - SSH** и установите этот плагин.

3. **Откройте Remote Explorer**  
   - Нажмите на иконку «Open Remote Window» (в левом нижнем углу VS Code, значок со стрелочками).  
   - Нажмите на кнопку «+» или выберите «Add New SSH Host».

4. **Настройте подключение**  
   - При появлении запроса укажите команду для подключения (SSH):
     ```bash
     ssh user@vm_ip_address
     ```
     где:
     - `user` — имя пользователя на сервере (первая часть в названии SSH-ключа до «@» в вашем репозитории).
     - `vm_ip_address` — IP-адрес сервера (вторая часть в названии SSH-ключа).
   - Когда VS Code попросит выбрать файл конфигурации, укажите:
     ```
     ~/.ssh/config
     ```

5. **Настройте файл конфигурации с ForwardAgent**  
   - Если файл `~/.ssh/config` уже существует, отредактируйте его. Если нет, плагин создаст этот файл.  
   - Добавьте в него конфигурацию для сервера, например:
     ```
     Host my_server
         HostName vm_ip_address
         User user
         IdentityFile /path/to/your/key/user@vm_ip_address.key
         ForwardAgent yes
     ```
     Пояснения к параметрам:
     - **Host** — псевдоним для сервера.
     - **HostName** — IP-адрес сервера.
     - **User** — имя пользователя для подключения.
     - **IdentityFile** — путь к приватному ключу.
     - **ForwardAgent** — позволяет «пробросить» локальный SSH-ключ на сервер и использовать его (например, для клонирования репозиториев).

   - Сохраните изменения в `~/.ssh/config`.

6. **Подключитесь к серверу**  
   - Снова нажмите на иконку «Open Remote Window» внизу слева.
   - Выберите «Connect to Host».
   - Найдите в списке и выберите ваш псевдоним `my_server`, нажмите **Connect**.
   - После подключения VS Code откроет удалённую сессию на сервере.
   - Нажмите **Open** / **Open Folder** и откройте нужную директорию (например, папку с проектом).

---

# Инструкция по клонированию репозитория на сервере

Процесс клонирования репозитория GitLab на сервер при помощи ForwardAgent.

## 1. Проверка наличия SSH-ключа на локальной машине

1. **Проверьте, есть ли SSH-ключи**  
   ```bash
   ls ~/.ssh
   ```
   Если видите файлы `id_ed25519` и `id_ed25519.pub`, значит ключ уже существует.

2. **Создайте SSH-ключ (если нет)**  
   ```bash
   ssh-keygen -t ed25519 -C "your_email@example.com"
   ```
   - Нажмите Enter, чтобы сохранить ключ в стандартную директорию `~/.ssh/id_ed25519`.

3. **Убедитесь, что ключ создан**  
   ```bash
   ls ~/.ssh
   ```
   Должны появиться файлы `id_ed25519` (приватный) и `id_ed25519.pub` (публичный).

---

## 2. Добавление публичного ключа в GitLab

1. **Скопируйте публичный ключ**  
   ```bash
   cat ~/.ssh/id_ed25519.pub
   ```
   Скопируйте вывод, начиная с `ssh-ed25519`.

2. **Добавьте ключ в GitLab**  
   - Откройте GitLab и перейдите в **Settings** → **SSH Keys**.  
   - Вставьте скопированный публичный ключ в текстовое поле.  
   - Укажите любое понятное название (например, «Local Machine») и нажмите **Add Key**.

3. **Загрузите ключ в SSH-агент на локальной машине**  
   ```bash
   ssh-add ~/.ssh/id_ed25519
   ```
   Теперь локальный ключ будет использоваться при подключении к серверу с опцией ForwardAgent.

---

## 3. Проверка ForwardAgent и клонирование репозитория

1. **Убедитесь, что SSH-ключ доступен на сервере**  
   В удалённой сессии (VS Code → терминал на сервере):
   ```bash
   ssh-add -L
   ```
   Если вы видите ваш публичный ключ (начинающийся на `ssh-ed25519`), значит ключ успешно проброшен.

2. **Получите SSH-ссылку для репозитория в GitLab**  

   ```
   git@gitlab.com:username/repository.git
   ```

3. **Выполните команду клонирования**  
   В терминале VS Code, уже подключённом к серверу:
   ```bash
   git clone git@gitlab.com:username/repository.git
   ```
   После этого в файловой системе сервера появится склонированный репозиторий.

---

# Инструкция по обновлению пакетов и установке Docker Compose на сервере

1. **Обновите список пакетов и установите обновления**  
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Установите Docker Compose** (Docker уже установлен)  
   ```bash
   sudo apt install docker-compose -y
   ```

3. **Проверьте установку**  
   ```bash
   docker-compose --version
   ```
   Должна отобразиться версия Docker Compose.

---

# Примечание о доступных портах на виртуальной машине

Для доступа к сервису из внешней сети один из разрешенных внешнийх портов сервера - 443, который перенаправляется на внутренний порт контейнера (8000). В файле `docker-compose.yaml` это указывается в разделе `ports` для  gpt_bot_service:

```yaml
ports:
  - "443:8000"
```

- **443** — порт, доступный снаружи (Human or not).  
- **8000** — порт внутри контейнера, на котором работает ваше приложение.  

Таким образом, при обращении к серверу по порту 443 запросы перенаправляются внутрь контейнера на порт 8000.
